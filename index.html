<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garage Manager PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        /* Custom scrollbar for better look */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #a0a0a0;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Style for the printable job card (modal visibility) */
        @media print {
            body * {
                visibility: hidden;
            }
            #jobCardModal, #jobCardModal * {
                visibility: visible;
                /* Reset positioning for print */
                position: relative;
                top: 0;
                left: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background-color: white !important;
            }
            #jobCardModal {
                display: block !important;
                height: auto;
            }
            /* Hide modal buttons in print view */
            .modal-actions {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-600 shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-white tracking-wider">Garage Manager PRO</h1>
            <nav class="flex space-x-4">
                <button id="nav-car-entry" class="text-white hover:text-blue-200 font-medium transition duration-150">New Car Entry</button>
                <button id="nav-general-service" class="text-white hover:text-blue-200 font-medium transition duration-150">General Service</button>
                <button id="nav-error-checker" class="text-white hover:text-blue-200 font-medium transition duration-150">Error Code Checker</button>
                <button id="nav-car-list" class="text-white hover:text-blue-200 font-medium transition duration-150">Active Jobs</button>
                <button id="nav-completed-list" class="text-white hover:text-blue-200 font-medium transition duration-150">Completed Jobs</button>
                <button id="nav-reports-section" class="text-white hover:text-blue-200 font-bold py-2 px-4 rounded-lg bg-yellow-600 hover:bg-yellow-700 transition duration-150">Reports</button>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-150" style="display:none;">Logout</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <section id="auth-section" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl space-y-6">
            <h2 class="text-3xl font-bold text-center text-blue-600">Login / Signup</h2>
            <form id="auth-form" class="space-y-4">
                <input id="email" type="email" placeholder="Email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                <input id="password" type="password" placeholder="Password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" />
                <div class="flex space-x-4">
                    <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-150">Login</button>
                    <button type="button" id="signupBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-150">Signup</button>
                </div>
            </form>
            <p id="auth-error" class="text-red-500 text-center" style="display:none;"></p>
        </section>

        <section id="car-entry" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">üöó New Car Repair Job Entry</h2>
            <form id="car-entry-form" onsubmit="return false;" class="space-y-6 bg-white p-6 rounded-xl shadow-lg">
                <fieldset class="border-2 border-blue-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-blue-700 px-2">Client & Job Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                        <input id="clientName" type="text" placeholder="Client Full Name" required class="p-3 border rounded-lg" />
                        <input id="clientEmail" type="email" placeholder="Client Email" class="p-3 border rounded-lg" />
                        <input id="clientPhone" type="tel" placeholder="Phone Number" class="p-3 border rounded-lg" />
                        <input id="assignedMechanic" type="text" placeholder="Assigned Mechanic" required class="p-3 border rounded-lg" />
                        <input id="dueDate" type="date" placeholder="Due Date" class="p-3 border rounded-lg" />
                        <select id="jobStatus" class="p-3 border rounded-lg">
                            <option value="Active">Active</option>
                            <option value="Completed">Completed</option>
                        </select>
                    </div>
                </fieldset>
                
                <fieldset class="border-2 border-blue-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-blue-700 px-2">Vehicle Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-4">
                        <input id="plateNo" type="text" placeholder="Plate Number (Required)" required class="p-3 border rounded-lg" />
                        <input id="vin" type="text" placeholder="VIN" class="p-3 border rounded-lg" />
                        <input id="make" type="text" placeholder="Make (e.g., Toyota)" class="p-3 border rounded-lg" />
                        <input id="model" type="text" placeholder="Model (e.g., Corolla)" class="p-3 border rounded-lg" />
                        <input id="year" type="number" placeholder="Year" class="p-3 border rounded-lg" />
                        <input id="color" type="text" placeholder="Color" class="p-3 border rounded-lg" />
                        <input id="engineCC" type="number" placeholder="Engine CC" class="p-3 border rounded-lg" />
                        <input id="trim" type="text" placeholder="Trim Level" class="p-3 border rounded-lg" />
                        <input id="engineName" type="text" placeholder="Engine Name" class="p-3 border rounded-lg" />
                        <input id="transmission" type="text" placeholder="Transmission" class="p-3 border rounded-lg" />
                        <input id="driveType" type="text" placeholder="Drive Type" class="p-3 border rounded-lg" />
                    </div>
                </fieldset>

                <fieldset class="border-2 border-blue-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-blue-700 px-2">Diagnostic & Repair</legend>
                    <div class="space-y-4">
                        <textarea id="reportedProblems" rows="3" placeholder="Client Reported Problems" required class="w-full p-3 border rounded-lg"></textarea>
                        <textarea id="diagnosticNotes" rows="3" placeholder="Mechanic's Diagnostic Notes" class="w-full p-3 border rounded-lg"></textarea>
                        <div id="error-codes-container" class="space-y-2">
                            </div>
                        <button type="button" onclick="addErrorCodeInput()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Add Error Code</button>
                        <div id="repair-plan-container" class="space-y-4">
                            </div>
                        <button type="button" onclick="addRepairPlanCard()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Add Repair Plan Step</button>
                        <textarea id="replacementParts" rows="2" placeholder="Replacement Parts Required/Used" class="w-full p-3 border rounded-lg"></textarea>
                        <textarea id="repairNotes" rows="3" placeholder="Final Repair Notes / Actions Taken" class="w-full p-3 border rounded-lg"></textarea>
                    </div>
                </fieldset>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" id="saveJobBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150">Save Job Entry</button>
                </div>
            </form>
        </section>
        
        <section id="general-service" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">üõ†Ô∏è General Service Entry (Oil Change, Brakes, etc.)</h2>
            <form id="general-service-form" onsubmit="return false;" class="space-y-6 bg-white p-6 rounded-xl shadow-lg">
                <fieldset class="border-2 border-green-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-green-700 px-2">Client & Vehicle Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                        <input id="gsClientName" type="text" placeholder="Client Full Name" required class="p-3 border rounded-lg" />
                        <input id="gsClientPhone" type="tel" placeholder="Phone Number" class="p-3 border rounded-lg" />
                        <input id="gsPlateNo" type="text" placeholder="Plate Number (Required)" required class="p-3 border rounded-lg" />
                        <input id="gsMake" type="text" placeholder="Make (e.g., Toyota)" class="p-3 border rounded-lg" />
                        <input id="gsModel" type="text" placeholder="Model (e.g., Corolla)" class="p-3 border rounded-lg" />
                        <input id="gsAssignedMechanic" type="text" placeholder="Assigned Mechanic" required class="p-3 border rounded-lg" />
                    </div>
                </fieldset>
                
                <fieldset class="border-2 border-green-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-green-700 px-2">Service Checklist</legend>
                    <div id="service-checklist" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                        </div>
                </fieldset>

                <fieldset class="border-2 border-green-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-green-700 px-2">Notes & Status</legend>
                    <div class="space-y-4">
                        <textarea id="gsNotes" rows="3" placeholder="Additional Notes or Findings" class="w-full p-3 border rounded-lg"></textarea>
                        <select id="gsJobStatus" class="p-3 border rounded-lg w-full">
                            <option value="Active">Active</option>
                            <option value="Completed">Completed</option>
                        </select>
                        <input id="gsDueDate" type="date" placeholder="Due Date" class="p-3 border rounded-lg w-full" />
                    </div>
                </fieldset>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="submit" id="saveGeneralServiceBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150">Save General Service Job</button>
                </div>
            </form>
        </section>

        <section id="car-list" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">üìã Active Jobs</h2>
            <div id="active-jobs-list" class="space-y-4">
                <p class="text-gray-500">Loading active jobs...</p>
            </div>
        </section>

        <section id="completed-list" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">‚úÖ Completed Jobs</h2>
            <div id="completed-jobs-list" class="space-y-4">
                <p class="text-gray-500">Loading completed jobs...</p>
            </div>
        </section>

        <section id="reports-section" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">üìä Manager Reports</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4 border border-yellow-300">
                    <h3 class="text-2xl font-semibold text-yellow-700">Daily Summary Report</h3>
                    <p class="text-sm text-gray-600">Overview of all jobs active and completed today.</p>
                    <div id="daily-report-summary" class="bg-yellow-50 p-4 rounded-lg">
                        <p>Loading summary...</p>
                    </div>
                    <button id="dailyDownloadBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full">Download Daily PDF Report</button>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-lg space-y-4 border border-purple-300">
                    <h3 class="text-2xl font-semibold text-purple-700">Monthly Performance Report</h3>
                    <p class="text-sm text-gray-600">Aggregate statistics and performance metrics for the current month.</p>
                    <div id="monthly-report-summary" class="bg-purple-50 p-4 rounded-lg">
                        <p>Loading summary...</p>
                    </div>
                    <button id="monthlyDownloadBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full">Download Monthly PDF Report</button>
                </div>
            </div>
        </section>

        <section id="error-checker-section" class="space-y-8" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">üîç DTC Lookup & Analysis Report</h2>
            <form id="error-checker-form" onsubmit="return false;" class="space-y-6 bg-white p-6 rounded-xl shadow-lg">
                <fieldset class="border-2 border-orange-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-orange-700 px-2">Client & Vehicle Details</legend>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mt-4">
                        <input id="checker-client-name" type="text" placeholder="Client Full Name" required class="p-3 border rounded-lg md:col-span-2" />
                        <input id="checker-phone" type="tel" placeholder="Phone Number" class="p-3 border rounded-lg" />
                        <input id="checker-plate" type="text" placeholder="Vehicle Number Plate" required class="p-3 border rounded-lg" />
                        <input id="checker-make" type="text" placeholder="Make (e.g., Toyota)" class="p-3 border rounded-lg" />
                        <input id="checker-model" type="text" placeholder="Model (e.g., Corolla)" class="p-3 border rounded-lg" />
                    </div>
                </fieldset>

                <fieldset class="border-2 border-indigo-200 p-4 rounded-lg">
                    <legend class="text-xl font-semibold text-indigo-700 px-2">Error Codes (DTC) Entry & Comments</legend>
                    <div id="checker-error-codes-container" class="space-y-4 mt-4">
                    </div>
                    <button type="button" onclick="addErrorCheckerInput()" class="mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Add Error Code</button>
                </fieldset>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="showErrorCheckerReportModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg transition duration-150">Generate Report</button>
                    <button type="button" onclick="generateErrorCheckPDF()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-lg transition duration-150">Download PDF</button>
                    <button type="button" onclick="showErrorCheckerReportModal('print')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150">Print</button>
                </div>
            </form>
        </section>
        <div id="jobCardModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden justify-center items-center z-50">
            <div id="job-card-dialog" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto">
                <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Job Card / Report</h2>
                <div id="job-card-content" class="space-y-4">
                    </div>
                <div class="modal-actions flex justify-end space-x-4 mt-6">
                    <button id="whatsapp-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Send via WhatsApp</button>
                    <button id="closeModalBtn" onclick="document.getElementById('jobCardModal').style.display='none';" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Close</button>
                </div>
            </div>
        </div>
    </main>

<script type="module">
    // IMPORTANT: Assuming error_codes_dictionary.js is loaded and exports ERROR_CODE_LOOKUP
    // The dictionary is loaded and exposed to the window by the following import (in a real app)
    // import { ERROR_CODE_LOOKUP } from './error_codes_dictionary.js';
    // window.GLOBAL_ERROR_CODE_LOOKUP = ERROR_CODE_LOOKUP;
    // Since I cannot access the file content, I'll define a placeholder and assume the file loads the full one.
    // Placeholder to satisfy the lookupCheckerCode function:
    window.GLOBAL_ERROR_CODE_LOOKUP = window.GLOBAL_ERROR_CODE_LOOKUP || {
        "P001A": { issuer: "Powertrain", meaning: "Intake 'A' Camshaft Position Actuator Performance (Bank 1)" },
        "B1475": { issuer: "Body", meaning: "Interior Light Circuit Failure" },
        "C0040": { issuer: "Chassis", meaning: "Brake Pedal Sensor A Circuit Malfunction" }
    };

    // ----------------------------------------------------------------------
    // 1. STATE & UTILS
    // ----------------------------------------------------------------------

    let userIsLoggedIn = false;
    let jobData = [];
    window.currentJobData = null; // Global variable to hold current job data for PDF/WhatsApp

    const serviceChecklistItems = [
        "Oil Change", "Oil Filter", "Air Filter", "Cabin Filter", "Brake Pads", 
        "Tire Rotation", "Fluid Levels", "Lights Check", "Wiper Blades", "Battery Check"
    ];
    
    // ----------------------------------------------------------------------
    // 2. AUTHENTICATION (Placeholder)
    // ----------------------------------------------------------------------

    function handleLoginSignup(event) {
        // ... (Existing login/signup logic)
        // Placeholder for authentication success:
        userIsLoggedIn = true;
        document.getElementById('auth-section').style.display = 'none';
        document.getElementById('logoutBtn').style.display = 'block';
        showSection('car-list'); // Show active jobs on login
        event.preventDefault();
    }

    function handleLogout() {
        // ... (Existing logout logic)
        userIsLoggedIn = false;
        document.getElementById('logoutBtn').style.display = 'none';
        showSection('auth-section');
    }

    // ----------------------------------------------------------------------
    // 3. NAVIGATION & SECTION DISPLAY
    // ----------------------------------------------------------------------

    function showSection(sectionId) {
        // MODIFICATION 1: Added 'error-checker-section'
        const sections = ['auth-section', 'car-entry', 'general-service', 'car-list', 'completed-list', 'reports-section', 'error-checker-section']; 
        
        sections.forEach(id => {
            const section = document.getElementById(id);
            if (section) {
                section.style.display = id === sectionId ? 'block' : 'none';
            }
        });
        
        // Handle specific initializations: Initialize the first error input for the checker if none exist.
        if (sectionId === 'error-checker-section' && document.getElementById('checker-error-codes-container').children.length === 0) {
            window.addErrorCheckerInput(); 
        }

        if (sectionId === 'car-entry') {
            // Re-initialize New Car Entry error codes and repair plan
            document.getElementById('error-codes-container').innerHTML = '';
            document.getElementById('repair-plan-container').innerHTML = '';
            window.addErrorCodeInput(); 
            window.addRepairPlanCard('Full diagnostic and repair of error codes.', '');
        }

        if (sectionId === 'general-service') {
            renderServiceChecklist();
        }

        if (sectionId === 'car-list' || sectionId === 'completed-list') {
            renderJobList(sectionId);
        }

        if (sectionId === 'reports-section') {
            generateReports();
        }
    }
    
    // ... (Existing functions: renderServiceChecklist, addErrorCodeInput, removeErrorCodeInput, addRepairPlanCard, removeRepairPlanCard, collectCarEntryData, saveJobEntry, renderJobCard, updateJobStatus, renderJobList, generateReports, generateReportPDF)

    // ----------------------------------------------------------------------
    // 4. MODAL & REPORT RENDERING (Partially Modified)
    // ----------------------------------------------------------------------

    function renderJobCardContent(data, status) {
        const jobCardContent = document.getElementById('job-card-content');
        const dialogEl = document.getElementById('job-card-dialog');
        // Define a list of possible max-width classes for cleanup
        const widthClasses = ['max-w-3xl', 'max-w-xl', 'max-w-4xl']; 
    
        // 1. Clear existing width classes from the dialog element
        dialogEl.classList.remove(...widthClasses);

        // START MODIFICATION: Handle new Error Checker Report Type
        if (data.jobType === 'ErrorCheckerReport') {
            // Set a wider modal for better readability of the report
            dialogEl.classList.add('max-w-4xl');
            
            // Format the error codes with dictionary meaning and user comments
            const errorDetailsHTML = data.errorDetails && data.errorDetails.length > 0 ? `
                <div class="space-y-4">
                ${data.errorDetails.map(item => `
                    <div class="p-4 border border-indigo-300 bg-indigo-50 rounded-lg shadow-sm">
                        <p class="font-bold text-lg text-indigo-700 mb-1">DTC Code: ${item.code}</p>
                        <p class="text-sm border-b pb-2"><span class="font-semibold text-gray-700">Dictionary Meaning:</span> ${item.dictionaryMeaning}</p>
                        <p class="mt-2 text-sm"><span class="font-semibold text-gray-700">Mechanic Comment:</span> ${item.userComment}</p>
                    </div>
                `).join('')}
                </div>
            ` : '<p class="text-gray-500">No error codes analyzed.</p>';
            
            jobCardContent.innerHTML = `
                <div class="grid grid-cols-2 gap-4 border-b pb-4">
                    <div><p><span class="font-bold">Report Type:</span> DTC Analysis Report</p></div>
                    <div><p><span class="font-bold">Client:</span> ${data.clientName}</p></div>
                    <div><p><span class="font-bold">Vehicle:</span> ${data.make} ${data.model}</p></div>
                    <div><p><span class="font-bold">Plate No:</span> ${data.plate}</p></div>
                    <div><p><span class="font-bold">Phone:</span> ${data.clientPhone}</p></div>
                </div>
                
                <h3 class="text-xl font-bold text-indigo-700 mt-4 border-b-2 pb-1">Error Code Details</h3>
                ${errorDetailsHTML}
                
                <p class="text-sm text-gray-500 mt-6">Note: This report is a preliminary analysis based on a dictionary lookup. Always perform a full system diagnosis.</p>
            `;
            
            // Set WhatsApp button handler
            document.getElementById('whatsapp-btn').onclick = () => sendJobCardViaWhatsApp();

        // END MODIFICATION
        } else if (data.jobType === 'GeneralService') {
            // ... (Existing GeneralService logic) ...
            dialogEl.classList.add('max-w-xl');
            jobCardContent.innerHTML = `...`; // Placeholder: Existing HTML structure for GeneralService
            document.getElementById('whatsapp-btn').onclick = () => sendJobCardViaWhatsApp();
        } else { // StandardRepair logic (Original)
            // ... (Existing StandardRepair logic) ...
            dialogEl.classList.add('max-w-3xl');
            jobCardContent.innerHTML = `...`; // Placeholder: Existing HTML structure for StandardRepair
            document.getElementById('whatsapp-btn').onclick = () => sendJobCardViaWhatsApp();
        }
    }


    function sendJobCardViaWhatsApp() {
        const data = window.currentJobData;
        if (!data) {
            alert("No job data available to send.");
            return;
        }

        let message = `*Garage Manager PRO - Job Report*\n\n`;
        
        // START MODIFICATION: Add support for ErrorCheckerReport
        if (data.jobType === 'ErrorCheckerReport') {
            message += `*DTC Analysis for ${data.make} ${data.model} (${data.plate})*\n\n`;
            message += `*Client*: ${data.clientName}\n`;
            message += `*Phone*: ${data.clientPhone}\n\n`;
            message += `*Error Code Breakdown:*\n`;
            
            data.errorDetails.forEach(item => {
                message += `\n*Code*: ${item.code}\n`;
                // Use a simplified meaning for WhatsApp
                message += `*Meaning*: ${item.dictionaryMeaning.split(': ')[1] || item.dictionaryMeaning}\n`;
                message += `*Comment*: ${item.userComment}\n`;
            });
            message += `\n_A comprehensive PDF report is available upon request._`;
        // END MODIFICATION
        } else if (data.jobType === 'GeneralService') {
            // ... (Existing GeneralService logic)
            message += `...`; // Placeholder for existing GeneralService message
        } else { // StandardRepair logic
            // ... (Existing StandardRepair logic)
            message += `...`; // Placeholder for existing StandardRepair message
        }
        
        // ... (Existing WhatsApp link creation logic) ...
        const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
    }
    
    // ----------------------------------------------------------------------
    // 9. ERROR CODE CHECKER LOGIC (NEW SECTION)
    // ----------------------------------------------------------------------

    // Function to add a new error code input group for the checker section, including comment box.
    function addErrorCheckerInput(initialCode = '') {
        const container = document.getElementById('checker-error-codes-container');
        const newGroup = document.createElement('div');
        newGroup.className = 'error-code-group space-y-2 p-3 border border-indigo-100 rounded-lg bg-indigo-50';
        newGroup.innerHTML = `
            <div class="flex space-x-2 items-center">
                <input type="text" value="${initialCode}" placeholder="Pxxxx (e.g., P001A)" class="error-code-input p-2 border rounded-lg w-full md:w-1/4" />
                <button type="button" onclick="lookupCheckerCode(this)" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 whitespace-nowrap">Lookup Meaning</button>
                <button type="button" onclick="removeErrorCheckerInput(this)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Remove</button>
            </div>
            <div class="md:flex md:space-x-4">
                <div class="w-full md:w-1/2">
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Dictionary Meaning</label>
                    <input type="hidden" class="dictionary-meaning-hidden" value="" />
                    <p class="error-code-explanation text-sm p-2 bg-white text-gray-800 border rounded-lg h-10 overflow-hidden" style="display:block;">Enter code and click lookup.</p>
                </div>
                <div class="w-full md:w-1/2 mt-2 md:mt-0">
                    <label for="comment-box" class="block text-xs font-semibold text-gray-700 mb-1">Your Message/Comments</label>
                    <textarea rows="2" placeholder="Enter notes, diagnosis or next steps..." class="user-comment-box w-full p-2 border rounded-lg text-sm"></textarea>
                </div>
            </div>
        `;
        container.appendChild(newGroup);
    }

    // Function to remove the error code input group for the checker section
    function removeErrorCheckerInput(buttonEl) {
        const group = buttonEl.closest('.error-code-group');
        if (group) {
            group.remove();
        }
    }

    // Function to perform the dictionary lookup in the checker section
    function lookupCheckerCode(buttonEl) {
        const group = buttonEl.closest('.error-code-group');
        const codeInput = group.querySelector('.error-code-input');
        const displayEl = group.querySelector('.error-code-explanation');
        const hiddenMeaningEl = group.querySelector('.dictionary-meaning-hidden');
        
        const code = codeInput.value.toUpperCase().trim();
        if (code.length === 0) {
            displayEl.innerHTML = `Please enter a code.`;
            displayEl.className = 'error-code-explanation text-sm p-2 bg-red-50 text-red-800 rounded mt-1 h-auto';
            hiddenMeaningEl.value = '';
            return;
        }

        const definition = window.GLOBAL_ERROR_CODE_LOOKUP[code];
        let fullMeaning = '';

        if (definition) {
            fullMeaning = `${definition.issuer}: ${definition.meaning}`;
            displayEl.innerHTML = `‚úÖ <strong>${code}</strong>: ${fullMeaning}`;
            displayEl.className = 'error-code-explanation text-sm p-2 bg-green-50 text-green-800 rounded mt-1 h-auto';
            hiddenMeaningEl.value = fullMeaning;
        } else {
            displayEl.innerHTML = `‚ö†Ô∏è <strong>${code}</strong>: No definition found in the local dictionary.`;
            displayEl.className = 'error-code-explanation text-sm p-2 bg-red-50 text-red-800 rounded mt-1 h-auto';
            hiddenMeaningEl.value = `${code}: No definition found.`;
        }
    }

    // Function to collect all error codes, meanings, and comments from the checker section
    function getAllCheckerErrorCodes() {
        const groups = document.querySelectorAll('#checker-error-codes-container .error-code-group');
        const results = [];
        
        groups.forEach(group => {
            const codeInput = group.querySelector('.error-code-input').value.toUpperCase().trim();
            const dictionaryMeaning = group.querySelector('.dictionary-meaning-hidden').value.trim();
            const userComment = group.querySelector('.user-comment-box').value.trim();
            
            if (codeInput.length > 0) {
                // Ensure lookup is performed for the report if the field is empty (meaning user didn't click lookup)
                let finalMeaning = dictionaryMeaning;
                if (!finalMeaning || finalMeaning === `${codeInput}: No definition found.`) {
                     const definition = window.GLOBAL_ERROR_CODE_LOOKUP[codeInput];
                     if (definition) {
                        finalMeaning = `${definition.issuer}: ${definition.meaning}`;
                     } else {
                        finalMeaning = `${codeInput}: Not looked up/No data.`;
                     }
                }

                results.push({
                    code: codeInput,
                    dictionaryMeaning: finalMeaning,
                    userComment: userComment || 'No comment entered.'
                });
            }
        });
        return results;
    }

    // Function to prepare data and show the report modal
    function showErrorCheckerReportModal(actionType = 'show') {
        const errorData = getAllCheckerErrorCodes();
        
        if (errorData.length === 0) {
            alert("Please enter at least one error code to generate a report.");
            return;
        }
        
        const clientName = document.getElementById('checker-client-name').value.trim();
        const plate = document.getElementById('checker-plate').value.trim();

        if (clientName === '' || plate === '') {
            alert("Please enter the Client Name and Vehicle Plate Number.");
            return;
        }

        const data = {
            // CLIENT INFO
            clientName: clientName,
            clientPhone: document.getElementById('checker-phone').value || 'N/A',
            make: document.getElementById('checker-make').value || 'N/A',
            model: document.getElementById('checker-model').value || 'N/A',
            plate: plate,
            
            // JOB DETAILS (Using minimal data to fit job card structure)
            jobType: 'ErrorCheckerReport', // NEW Job Type identifier
            errorDetails: errorData, // Detailed array for rendering
            // Other fields required by existing functions but unused by this report:
            clientEmail: 'N/A', reportedProblems: 'DTC analysis requested.', diagnosticNotes: 'Analysis generated from client-provided error codes.',
            assignedMechanic: 'N/A', dueDate: 'N/A', deliveryDate: 'N/A', vin: 'N/A', year: 'N/A', color: 'N/A', engineCC: 'N/A', trim: 'N/A', 
            engineName: 'N/A', transmission: 'N/A', driveType: 'N/A', repairPlanItems: [], repairNotes: 'N/A', replacementParts: 'N/A'
        };
        
        // Set the global jobData for PDF/WhatsApp to use
        window.currentJobData = data; 

        // Render the content and show the modal
        renderJobCardContent(data, 'Error Checker Report');
        document.getElementById('jobCardModal').style.display = 'flex';
        
        // Handle the 'print' action
        if (actionType === 'print') {
            setTimeout(() => window.print(), 300); // Wait for modal to render
        }
    }

    // Function to generate PDF for the Error Check Report
    function generateErrorCheckPDF() {
        // Collect data and ensure it's in window.currentJobData
        showErrorCheckerReportModal('pdf'); 
        const data = window.currentJobData;

        // Check again in case showErrorCheckerReportModal was prevented by validation
        if (!data || data.jobType !== 'ErrorCheckerReport') return; 
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let y = 15;

        // Header
        doc.setFontSize(22);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(59, 130, 246); // blue-500
        doc.text("DTC Analysis Report", 105, y, null, null, "center");
        y += 8;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(107, 114, 128); // gray-500
        doc.text(`Generated on: ${new Date().toLocaleDateString()} | Garage Manager PRO`, 105, y, null, null, "center");
        y += 15;

        // 1. Client and Vehicle Details
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(249, 115, 22); // orange-600
        doc.text("Client & Vehicle", 14, y);
        doc.setTextColor(0, 0, 0); 
        y += 5;
        
        doc.autoTable({
            startY: y,
            body: [
                ['Client Name', data.clientName, 'Phone', data.clientPhone],
                ['Plate No.', data.plate, 'Make/Model', `${data.make} ${data.model}`]
            ],
            theme: 'plain',
            styles: { fontSize: 10, cellPadding: 2, lineWidth: 0.1, lineColor: 200 },
            columnStyles: { 0: { fontStyle: 'bold', cellWidth: 40 }, 2: { fontStyle: 'bold', cellWidth: 40 } },
            margin: { left: 14 }
        });
        y = doc.autoTable.previous.finalY + 15;

        // 2. Error Code Analysis Table
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(99, 102, 241); // indigo-600
        doc.text("Error Code Analysis", 14, y);
        doc.setTextColor(0, 0, 0); 
        y += 8;
        
        const tableData = data.errorDetails.map(e => [
            e.code, 
            e.dictionaryMeaning, 
            e.userComment
        ]);

        doc.autoTable({
            startY: y,
            head: [['DTC Code', 'Dictionary Meaning / Issuer', 'Mechanic Comments']],
            body: tableData,
            theme: 'striped',
            headStyles: { fillColor: [99, 102, 241], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 10 },
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            columnStyles: {
                0: { cellWidth: 20, fontStyle: 'bold' },
                1: { cellWidth: 80 },
                2: { cellWidth: 80 }
            },
            margin: { left: 14 }
        });
        y = doc.autoTable.previous.finalY + 15;

        // Footer
        doc.setFontSize(8);
        doc.setTextColor(156, 163, 175); // gray-400
        doc.text(`This report provides a general lookup. Always verify diagnosis with vehicle-specific manuals.`, 14, doc.internal.pageSize.height - 10);

        doc.save(`DTC_Report_${data.plate}.pdf`);
    }

    // ----------------------------------------------------------------------
    // 10. INITIALIZATION
    // ----------------------------------------------------------------------
    
    document.addEventListener('DOMContentLoaded', () => {
        // Expose functions globally for use in HTML attributes
        window.handleLoginSignup = handleLoginSignup;
        window.showSection = showSection;
        // ... (Other existing exposed functions)

        // START MODIFICATION: Expose new Error Checker functions
        window.addErrorCheckerInput = addErrorCheckerInput;
        window.removeErrorCheckerInput = removeErrorCheckerInput;
        window.lookupCheckerCode = lookupCheckerCode;
        window.showErrorCheckerReportModal = showErrorCheckerReportModal;
        window.generateErrorCheckPDF = generateErrorCheckPDF;
        // END MODIFICATION
        
        // ... (Existing event listeners and initializations) ...
        
        function attachNavHandlers() {
            const navButtons = [
                { id: 'nav-car-entry', section: 'car-entry' },
                { id: 'nav-general-service', section: 'general-service' },
                // START MODIFICATION: Add new nav button
                { id: 'nav-error-checker', section: 'error-checker-section' },
                // END MODIFICATION
                { id: 'nav-car-list', section: 'car-list' },
                { id: 'nav-completed-list', section: 'completed-list' },
                { id: 'nav-reports-section', section: 'reports-section' }
            ];

            navButtons.forEach(({ id, section }) => {
                const button = document.getElementById(id);
                if (button) {
                    // Use a proper event listener instead of inline onclick
                    button.addEventListener('click', () => showSection(section));
                }
            });
        }
        
        attachNavHandlers();
        
        // Initialize the first error code input field
        addErrorCodeInput(); 
        // Initialize the first repair plan card
        // ... (Existing initialization logic for New Car Entry/General Service) ...
    });

</script>

</body>
</html>
