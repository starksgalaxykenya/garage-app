<script type="module">

    // NEW: Import the local error code dictionary
    import { ERROR_CODE_LOOKUP } from "./error_codes_dictionary.js";
    // MODIFICATION 2: Expose dictionary globally for functions called via onclick to access
    window.GLOBAL_ERROR_CODE_LOOKUP = ERROR_CODE_LOOKUP; 
    
    // ----------------------------------------------------------------------
    // 1. FIREBASE INITIALIZATION & CONFIGURATION (MODULAR)
    // ----------------------------------------------------------------------

    // Import the functions you need from the SDKs
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyBCvFltNyGj3SYR-ADUocWD5EVjljoCEp8",
        authDomain: "garage-manager-1ac7c.firebaseapp.com",
        projectId: "garage-manager-1ac7c",
        storageBucket: "garage-manager-1ac7c.firebasestorage.app",
        messagingSenderId: "226684256206",
        appId: "1:226684256206:web:13d600d6db4c603506759f"
    };

    // Initialize Firebase Services
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const carsCollection = collection(db, 'cars');
    let currentUserRole = null; // 'admin' or 'mechanic'

    // MODIFICATION 4 FIX: Global variable to hold current job card data for modal and WhatsApp
    // It is now explicitly attached to window to be accessible by inline onclick handlers.
    window.currentJobCardData = null;
    
    // NEW: Global cache for completed jobs to power the daily report
    let completedJobsCache = [];
    
    // NEW: Global variables to temporarily hold the report data for PDF generation
    let currentReportJobs = [];
    let currentReportSummary = {};
    let currentReportTitle = "";
    let currentReportDateRange = "";

    // Expose functions globally for HTML onclick attributes
    window.showSection = showSection;
// ... (rest of exposed functions)
    window.generateDailyReport = generateDailyReport;
    window.generateMonthlyReport = generateMonthlyReport; 
    window.generateReportPDF = generateReportPDF; // EXPOSE PDF FUNCTION
    // END NEW
// ... (rest of the script)

// ----------------------------------------------------------------------
// 6. JOB CARD & REPORT GENERATION LOGIC (PDF/Modal) (MODIFIED: Added Plate)
// ----------------------------------------------------------------------

// ... (createJobCard function)

    function renderJobCardContent(data, status) {
        const jobCardContent = document.getElementById('job-card-content');
        
        // MODIFICATION 5: Handle General Service Job Type
        if (data.jobType === 'GeneralService') {
            // Set the global data for PDF generation via button click
            window.currentJobCardData = data; // MODIFIED: Use window.currentJobCardData
            // Adjust modal size for service report
            document.getElementById('jobCardModal').querySelector('.max-w-3xl').classList.remove('max-w-3xl');
            document.getElementById('jobCardModal').querySelector('.w-full').classList.add('max-w-xl');

            jobCardContent.innerHTML = `
                <div class="text-center border-b pb-4 mb-4">
                    <h2 class="text-3xl font-bold text-green-800">General Service Completion Report</h2>
                    <p class="text-sm text-gray-600">Job Type: ${data.reportedProblems}</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button onclick="generateServiceReportPDF(window.currentJobCardData)" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition duration-150 print:hidden">Generate Full Service Checklist PDF</button>
                </div>
            `;
            // Hide WhatsApp button for this specialized report
            document.getElementById('whatsapp-btn').style.display = 'none';
            return;
        }
        
        // If NOT GeneralService (i.e., standard car entry)
        document.getElementById('jobCardModal').querySelector('.max-w-xl').classList.remove('max-w-xl');
        document.getElementById('jobCardModal').querySelector('.w-full').classList.add('max-w-3xl');
        
        // MODIFICATION 4: Set the global data for WhatsApp function
        window.currentJobCardData = data; // MODIFIED: Use window.currentJobCardData
        document.getElementById('whatsapp-btn').style.display = 'block';

        // ... (rest of renderJobCardContent) ...
    }

    // MODIFICATION 4: WhatsApp button functionality (MODIFIED: Added Plate)
    function sendJobCardViaWhatsApp() {
        if (!window.currentJobCardData) { // MODIFIED: Use window.currentJobCardData
            alert("No job card data available to send.");
            return;
        }

        const data = window.currentJobCardData; // MODIFIED: Use window.currentJobCardData
        
        // ... (rest of sendJobCardViaWhatsApp) ...
    }
// ... (rest of the script)
</script>
