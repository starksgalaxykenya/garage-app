<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Code Manager - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .service-table th {
            text-align: left;
            padding: 12px 16px;
            background-color: #f3f4f6;
            font-weight: 600;
        }
        .service-table td {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <header class="bg-indigo-800 shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex justify-between items-center">
            <h1 class="text-3xl font-extrabold text-white">Error Code Manager</h1>
            <a href="index V5.html" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-150">Back to Main App</a>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <section id="auth-check">
            <div class="flex justify-center items-center py-16">
                <p class="text-xl font-semibold text-gray-600">Loading authentication status...</p>
            </div>
        </section>

        <section id="admin-panel" class="space-y-12" style="display:none;">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2">âž• Add New Error Code</h2>
            <form id="add-code-form" class="space-y-4 bg-white p-6 rounded-xl shadow-lg">
                <p class="text-red-500 font-semibold" id="form-error-message"></p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input id="new-code" type="text" placeholder="Error Code (e.g., P0300)" required class="p-3 border rounded-lg uppercase" />
                    <input id="new-issuer" type="text" placeholder="Issuer (e.g., Powertrain)" required class="p-3 border rounded-lg" />
                    <input id="new-meaning" type="text" placeholder="Meaning (e.g., Cylinder Misfire)" required class="p-3 border rounded-lg" />
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition duration-150">Add Code to Dictionary</button>
            </form>

            <h2 class="text-3xl font-bold text-gray-800 border-b pb-2 pt-8">ðŸ“š Current Error Code Dictionary</h2>
            <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                <table class="w-full service-table text-sm">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>Issuer</th>
                            <th>Meaning</th>
                            <th class="w-16">Action</th>
                        </tr>
                    </thead>
                    <tbody id="codes-table-body">
                        <tr><td colspan="4" class="text-center text-gray-500">Loading codes...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
        
    </main>

<script type="module">
    // ----------------------------------------------------------------------
    // FIREBASE INITIALIZATION & CONFIGURATION
    // ----------------------------------------------------------------------

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, where } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // !! IMPORTANT !! Use your actual Firebase Config here. It should match index V5.html
    const firebaseConfig = {
        apiKey: "AIzaSyBCvFltNyGj3SYR-ADUocWD5EVjljoCEp8",
        authDomain: "garage-manager-1ac7c.firebaseapp.com",
        projectId: "garage-manager-1ac7c",
        storageBucket: "garage-manager-1ac7c.firebasestorage.app",
        messagingSenderId: "226684256206",
        appId: "1:226684256206:web:13d600d6db4c603506759f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const errorCodesCollection = collection(db, 'error_codes'); 
    
    // Global function needed for HTML onclick
    window.deleteErrorCode = deleteErrorCode; 

    // ----------------------------------------------------------------------
    // AUTHENTICATION AND VIEW MANAGEMENT
    // ----------------------------------------------------------------------
    
    // Check if user is logged in and is an admin (mock role)
    onAuthStateChanged(auth, (user) => {
        const authCheckEl = document.getElementById('auth-check');
        const adminPanelEl = document.getElementById('admin-panel');
        authCheckEl.style.display = 'none';

        if (user) {
            const userRole = user.email && user.email.toLowerCase().includes('admin') ? 'admin' : 'mechanic';
            if (userRole === 'admin') {
                adminPanelEl.style.display = 'block';
                // Initialize the dictionary display
                fetchErrorCodes(); 
            } else {
                authCheckEl.style.display = 'block';
                authCheckEl.innerHTML = '<p class="text-center text-2xl text-red-600 py-16">Access Denied: Only administrators can manage error codes.</p>';
            }
        } else {
            authCheckEl.style.display = 'block';
            authCheckEl.innerHTML = '<p class="text-center text-2xl text-blue-600 py-16">Please <a href="index V5.html" class="font-bold underline">login</a> to access the manager panel.</p>';
        }
    });

    // ----------------------------------------------------------------------
    // CRUD OPERATIONS
    // ----------------------------------------------------------------------

    document.getElementById('add-code-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        const code = document.getElementById('new-code').value.toUpperCase().trim();
        const issuer = document.getElementById('new-issuer').value.trim();
        const meaning = document.getElementById('new-meaning').value.trim();
        const messageEl = document.getElementById('form-error-message');
        messageEl.textContent = '';
        
        if (!code || !issuer || !meaning) {
            messageEl.textContent = 'All fields are required.';
            return;
        }

        try {
            // Check for duplicate code before adding
            const q = query(errorCodesCollection, where("code", "==", code));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                messageEl.textContent = `Error: Code ${code} already exists in the dictionary.`;
                return;
            }

            await addDoc(errorCodesCollection, {
                code: code,
                issuer: issuer,
                meaning: meaning,
                createdAt: new Date()
            });
            
            // Clear form on success
            document.getElementById('add-code-form').reset();
        } catch (error) {
            console.error("Error adding document: ", error);
            messageEl.textContent = `Failed to add code: ${error.message}`;
        }
    });

    function fetchErrorCodes() {
        const tableBody = document.getElementById('codes-table-body');
        const codesQuery = query(errorCodesCollection, orderBy('code', 'asc'));

        // Use onSnapshot for a live, always up-to-date table
        onSnapshot(codesQuery, (snapshot) => {
            tableBody.innerHTML = '';
            if (snapshot.empty) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400 py-6">No error codes defined yet.</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const codeData = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-mono text-indigo-700">${codeData.code}</td>
                    <td>${codeData.issuer}</td>
                    <td>${codeData.meaning}</td>
                    <td>
                        <button onclick="deleteErrorCode('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded text-xs transition duration-150">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        });
    }

    async function deleteErrorCode(docId) {
        if (!confirm('Are you sure you want to delete this error code permanently?')) return;
        
        try {
            await deleteDoc(doc(db, 'error_codes', docId));
        } catch (error) {
            alert(`Error deleting code: ${error.message}`);
            console.error("Error deleting document: ", error);
        }
    }
</script>
</body>
</html>